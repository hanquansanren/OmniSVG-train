# OmniSVG Training Configuration - REDUCED CHECKPOINT FREQUENCY
# è¿™ä¸ªé…ç½®æ˜¾è‘—å‡å°‘checkpointä¿å­˜é¢‘ç‡ï¼Œé¿å…NCCLè¶…æ—¶
# é€‚ç”¨äºå­˜å‚¨I/Oè¾ƒæ…¢çš„ç¯å¢ƒ

# ==============================================================================
# Model Configuration
# ==============================================================================
model:
  size: "4B"
  use_flash_attn: true
  torch_dtype: "bfloat16"
  
  # Gradient Checkpointing è®¾ç½®
  # æ³¨æ„ï¼šæ¨¡å‹å±‚é¢çš„ gradient_checkpointing ä¸ FSDP åœ¨ PyTorch 2.5.0 æœ‰å†²çª
  # è§£å†³æ–¹æ¡ˆï¼šå…³é—­æ¨¡å‹å±‚é¢çš„ï¼Œä½¿ç”¨ FSDP åŸç”Ÿçš„ activation_checkpointing
  # åœ¨ fsdp_config_transformer.yaml ä¸­å·²è®¾ç½® fsdp_activation_checkpointing: true
  # è¿™æ ·æ—¢èƒ½èŠ‚çœæ˜¾å­˜ï¼ˆ~30-40%ï¼‰ï¼Œåˆä¸ä¼šä¸ FSDP å†²çª
  use_gradient_checkpointing: false

# ==============================================================================
# Data Configuration  
# ==============================================================================
data:
  data_dir: "/data/phd23_weiguang_zhang/works/svg/my_zhuan2"
  
  # Reduced image size: 448 -> 336 (saves ~40% image memory)
  target_image_size: 224
  
  # Reduced sequence length: 2048 -> 1536 (saves ~25% sequence memory)
  max_seq_length: 2048
  text_max_length: 800
  
  text_source_probabilities:
    detail_description: 0.60
    brief_description: 0.40

# ==============================================================================
# Training Configuration
# ==============================================================================
training:
  learning_rate: 1.0e-4 # 1.0e-5
  weight_decay: 0.01 # 0.015
  max_grad_norm: 1.0 # 0.8
  
  epochs: 15
  # Increased gradient accumulation: 4 -> 8
  # This maintains effective batch size while using less memory per step
  gradient_accumulation_steps: 2
  
  scheduler:
    type: "cosine"
    warmup_steps: 500 # 50000
    num_cycles: 0.5
  
  task_balance:
    initial_text_only_ratio: 0.0
    # 0.5ï¼šå¹³è¡¡è®­ç»ƒï¼ˆæ¨èï¼‰
    # 0.7ï¼šåé‡æ–‡æœ¬ç†è§£
    # 1.0ï¼šçº¯æ–‡æœ¬åˆ°SVGï¼ˆæ˜¾å­˜å‹å¥½ï¼‰
    # 0.0ï¼šçº¯å›¾åƒåˆ°SVGï¼ˆéœ€è¦å¤§é‡æ˜¾å­˜ï¼‰
  
  loss_weights:
    text_task: 0 # 1.5
    image_task: 1.0

# ==============================================================================
# Logging and Checkpointing - ğŸ”´ ä¸»è¦ä¿®æ”¹åŒºåŸŸ
# ==============================================================================
logging:
  log_every: 15 # ä¿æŒä¸å˜ï¼šæ¯15æ­¥è®°å½•loss
  
  # â­ å…³é”®ä¿®æ”¹ï¼šå¤§å¹…å‡å°‘ä¿å­˜é¢‘ç‡
  save_every: 5000 # ä»2000æ”¹ä¸º5000 - å‡å°‘60%çš„ä¿å­˜æ¬¡æ•°
  # è¯´æ˜ï¼š
  # - 2000æ­¥ â†’ 5000æ­¥ï¼šè®­ç»ƒ15000æ­¥æ—¶ï¼Œä»7æ¬¡ä¿å­˜å‡å°‘åˆ°3æ¬¡
  # - æ˜¾è‘—é™ä½I/Oå‹åŠ›å’ŒNCCLè¶…æ—¶é£é™©
  # - ä»£ä»·ï¼šå¦‚æœè®­ç»ƒä¸­æ–­ï¼Œæœ€å¤šæŸå¤±5000æ­¥çš„è¿›åº¦ï¼ˆçº¦1-2å°æ—¶ï¼‰
  
  val_every: 1000 # ä¿æŒä¸å˜ï¼šæ¯1000æ­¥éªŒè¯
  # æ³¨æ„ï¼švalidationä¸ä¿å­˜checkpointï¼Œä¸ä¼šè¶…æ—¶

# å¦‚æœä»ç„¶è¶…æ—¶ï¼Œå¯ä»¥è¿›ä¸€æ­¥å¢åŠ åˆ°ï¼š
# save_every: 10000  # æ¯10000æ­¥ä¿å­˜ï¼ˆæ›´æ¿€è¿›ï¼‰
# save_every: 999999 # åŸºæœ¬ä¸ä¿å­˜ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰

# ==============================================================================
# DataLoader Configuration
# ==============================================================================
dataloader:
  num_workers: 4  # Reduced from 8 to save CPU memory
  pin_memory: true
  persistent_workers: true
  prefetch_factor: 2

# ==============================================================================
# Random Seed
# ==============================================================================
seed: 2023

# ==============================================================================
# ä½¿ç”¨è¯´æ˜
# ==============================================================================
# 
# 1. ä¿®æ”¹ debug_run_multi.sh ç¬¬83è¡Œï¼š
#    TRAIN_CONFIG_FILE="train_config_zhuan_less_save.yaml"
# 
# 2. è¿è¡Œè®­ç»ƒï¼š
#    bash debug_run_multi.sh
# 
# 3. æ•ˆæœï¼š
#    - ä¿å­˜é¢‘ç‡ï¼š2000æ­¥ â†’ 5000æ­¥
#    - ä¿å­˜æ¬¡æ•°å‡å°‘60%
#    - NCCLè¶…æ—¶é£é™©æ˜¾è‘—é™ä½
# 
# 4. å¦‚æœä»ç„¶è¶…æ—¶ï¼š
#    - å°† save_every æ”¹ä¸º 10000
#    - æˆ–ä½¿ç”¨æœ¬åœ°SSDå­˜å‚¨
# 
# ==============================================================================
